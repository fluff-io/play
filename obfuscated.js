console.log("loaded");const c=document.querySelector("canvas"),ctx=c.getContext("2d"),sqrt2=1.4142,nAngles=8,accuracy=4;for(var angles=[],i=0;i<8;i+=1)angles.push(Math.round(2*i*Math.PI*400/8)/400);const resize=()=>{w=c.width=window.innerWidth,h=c.height=window.innerHeight};function getRandomColor(){for(var e="#",t=0;t<6;t++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];return e}document.addEventListener("resize",resize),resize();const COLORS={FLBORDER:"#ccbc61",FLBODY:"#fbe778",WALL:"#585858",WALL_LIGHT:"#6c6c6c",WATER:"#2389da",WATER_LIGHT:"#2894e5",GRASS:"#3f9b0b",GRASS2:"#45a210",GRASS_LIGHT:"#5fba2b",NONE:"#000000"},TERTYPE={WALL:0,WALL_LIGHT:1,WATER:2,WATER_LIGHT:3,GRASS:4,GRASS2:5,GRASS_LIGHT:6,NONE:7},TERTYPE_REVERSE=["WALL","WALL_LIGHT","WATER","WATER_LIGHT","GRASS","GRASS2","GRASS_LIGHT","NONE"],pointOnCircle=(e,t,r,s)=>{let a=Math.cos(s),n=Math.sin(s);return[e+r*a,t+r*n]};class Terrain{constructor(e,t,r,s){this.w=e,this.h=t,this.x=0,this.y=0,this.dx=0,this.dy=0,this.units=e*t,this.pw=e*r,this.ph=t*r,this.res=r,this.data=s,this.factor=-1.25*Math.log((this.units-10)/this.units)+1.1,this.c=document.createElement("canvas"),this.ctx=this.c.getContext("2d"),this.c.width=e*r,this.c.height=t*r,void 0==this.data&&(this.data=[],this.data.length=e*t,this.data.fill(TERTYPE.NONE)),this.precedence={};for(var a=0;a<TERTYPE_REVERSE.length;a+=1)this.precedence[a]=a}checkCollision=(e,t,r,s=!1)=>(s||(e=Math.floor(e/this.res),t=Math.floor(t/this.res)),-1!=r.indexOf(this.data[t*this.w+e]));drawTile=(e,t,r,s,a)=>{void 0==a?s.fillStyle=COLORS[TERTYPE_REVERSE[r]]:s.fillStyle=a,s.fillRect(e*this.res,t*this.res,this.res,this.res)};set=(e,t,r)=>{this.data[t*this.w+e]=r};fill=(e,t,r,s,a)=>{for(var n,o=r;o<r+a;o+=1)n=o*this.w+t,this.data.fill(e,n,n+s)};random=(e,t,r,s,a,n,o=!0,d)=>{let $=t+s,l=r+a,f=Math.floor(this.w/n),x=Math.floor(this.h/n);var y=1;this.fill(e,t*f,r*x,s*f,a*x);var p,u,v,m=[],E=[],R=[],T=!1,L=0,S=this.precedence[e];if(void 0==d){for(var k=t*f;k<=$*f;k+=1)m.push([k,r*x]),m.push([k,l*x]);for(var k=r*x;k<=l*x;k+=1)m.push([t*f,k]),m.push([$*f,k])}else m=d.slice();for(m=_.shuffle(m);m.length>0;){L+=1,y*=m.length/1;for(var k=0;k<m.length;k+=1)if(y/=this.factor,!(!o&&(p=Math.random())>y)){for(var g=0;g<8;g+=1){switch(u=m[k].slice(),g){case 0:u[0]-=1;break;case 1:case 5:u[0]-=1,u[1]-=1;break;case 2:u[1]-=1;break;case 3:u[0]+=1,u[1]-=1;break;case 4:u[0]+=1;break;case 5:u[0]+=1,u[1]+=1;break;case 6:u[1]+=1}if(!(u[0]<0)&&!(u[0]>=this.w)&&!(u[1]<0)&&!(u[1]>=this.h)){if(v=u[1]*this.w+u[0],this.data[v]==e||this.precedence[this.data[v]]<S){switch(u=m[k].slice(),g%4){case 0:u[0]-=1;break;case 1:u[0]-=1,u[1]-=1;break;case 2:u[1]-=1;break;case 3:u[0]+=1,u[1]-=1}if(v=u[1]*this.w+u[0],this.data[v]==e||this.precedence[this.data[v]]<S){switch(u=m[k].slice(),g%4){case 0:u[0]+=1;break;case 1:u[0]+=1,u[1]+=1;break;case 2:u[1]+=1;break;case 3:u[0]-=1,u[1]-=1}if(v=u[1]*this.w+u[0],this.data[v]==e||this.precedence[this.data[v]]<S)continue}}o?(p=Math.random())<=y&&(!E.includes(u)&&(E.push(u.slice()),Math.random()>.25&&R.push(u.slice())),T=!0,this.data[v]=e):(E.includes(u)||E.push(u.slice()),this.data[v]=e)}}T?(R.splice(R.indexOf(m[k]),1),T=!1):R.push(m[k].slice())}m=[];for(var k=0;k<E.length;k++)m[k]=E[k].slice();m=E.slice(),E=[],m=_.shuffle(m)}return R};update=()=>{var e=0,t=0;this.ctx.clearRect(0,0,this.c.width,this.c.height);for(var r=0;r<this.units;r+=1)this.drawTile(e,t,this.data[r],this.ctx),(e+=1)>=this.w&&(e=0,t+=1)};move=(e,t,r=!0)=>{0!=e[0]&&0!=e[1]?(this.x+=e[0]*t/1.4142,this.y+=e[1]*t/1.4142):(this.x+=e[0]*t,this.y+=e[1]*t),r&&(this.dx=this.x,this.dy=this.y)};drawSection=(e,t,r,s,a)=>{a.drawImage(this.c,e,t,r,s,0,0,r,s)};fillRemaining=e=>{for(var t=0;t<this.units;t+=1)this.data[t]==TERTYPE.NONE&&(this.data[t]=TERTYPE.WALL)}}class Flower{constructor(e,t,r,s,a,n=!0){this.x=e,this.y=t,this.dx=e,this.dy=t,this.r=r,this.trueRadius=n,this.drawRadius=n?r-s:r,this.border=s,this.speed=a}move=(e,t=!0)=>{0!=e[0]&&0!=e[1]?(this.x+=e[0]*this.speed/1.4142,this.y+=e[1]*this.speed/1.4142):(this.x+=e[0]*this.speed,this.y+=e[1]*this.speed),t&&(this.dx=this.x,this.dy=this.y)};render=e=>{for(var t of(e.strokeStyle=COLORS.FLBORDER,e.fillStyle=COLORS.FLBODY,e.lineWidth=this.border,e.beginPath(),e.arc(this.dx,this.dy,this.drawRadius,0,2*Math.PI),e.stroke(),e.fill(),e.fillStyle="blue",angles));}}var terrain=new Terrain(1e3,1e3,10);terrain.dx=terrain.pw/2-w/2,terrain.dy=terrain.ph/2-h/2,terrain.x=terrain.dx,terrain.y=terrain.dy;for(var border=void 0,i=0;i<30;i+=1)border=terrain.random(TERTYPE.GRASS,1,1,8,8,10,!0,border);terrain.fillRemaining(TERTYPE.WALL);for(var i=0;i<border.length;i+=1)terrain.set(...border[i],TERTYPE.GRASS_LIGHT);for(var j=0;j<3;j+=1){border=void 0;for(var e=Math.floor(3*Math.random())+2,t=Math.floor(3*Math.random())+2,i=0;i<2;i+=1)border=terrain.random(TERTYPE.WATER,e,t,1,1,10,!0,border);for(var i=0;i<border.length;i+=1)terrain.set(...border[i],TERTYPE.WATER_LIGHT)}for(var grass=!1,i=0;i<terrain.units;i+=1)grass&&terrain.data[i]==TERTYPE.GRASS?(terrain.data[i]=TERTYPE.GRASS2,grass=!1):grass||terrain.data[i]!=TERTYPE.GRASS||(grass=!0);terrain.update();var fl=new Flower(terrain.w/2*terrain.res,terrain.h/2*terrain.res,20,5,10);fl.dx=w/2,fl.dy=h/2;var keys={w:!1,a:!1,s:!1,d:!1},moveVector=[0,0];document.addEventListener("keydown",e=>{keys[e.key]=!0}),document.addEventListener("keyup",e=>{keys[e.key]=!1});var w,h,median,midx,prev=new Date,iter=0,pointsx=[],pointsy=[],stuckCounter=0,rightBound=terrain.pw-w/2,bottomBound=terrain.ph-h/2;const move=e=>{if(fl.move(e,!1),fl.x<=w/2||fl.x>=rightBound||fl.y<=h/2||fl.y>=bottomBound){var t=[fl.x<=w/2?0:fl.x-w/2,fl.y<=h/2?0:fl.y-h/2];fl.dx=0==t[0]?fl.x:w/2,fl.dy=0==t[1]?fl.y:h/2,terrain.x=terrain.dx=t[0],terrain.y=terrain.dy=t[1]}else fl.dx=w/2,fl.dy=h/2,terrain.x=terrain.dx=fl.x-w/2,terrain.y=terrain.dy=fl.y-h/2};var pPos=[fl.x,fl.y,terrain.x,terrain.y,fl.dx,fl.dy,terrain.dx,terrain.dy],fps=0;ctx.font="24px sans-serif";const draw=()=>{moveVector=[0,0],Number.isNaN(fl.x)&&(fl.x=pPos[0]+10*Math.random()),Number.isNaN(fl.y)&&(fl.y=pPos[1]+10*Math.random()),Number.isNaN(terrain.x)&&(terrain.x=pPos[2]+10*Math.random()),Number.isNaN(terrain.y)&&(terrain.y=pPos[3]+10*Math.random()),Number.isNaN(fl.dx)&&(fl.dx=pPos[4]+10*Math.random()),Number.isNaN(fl.dy)&&(fl.dy=pPos[5]+10*Math.random()),Number.isNaN(terrain.dx)&&(terrain.dx=pPos[6]+10*Math.random()),Number.isNaN(terrain.dy)&&(terrain.dy=pPos[7]+10*Math.random()),pPos=[fl.x,fl.y,terrain.x,terrain.y,fl.dx,fl.dy,terrain.dx,terrain.dy],keys.w&&(moveVector[1]-=1),keys.a&&(moveVector[0]-=1),keys.s&&(moveVector[1]+=1),keys.d&&(moveVector[0]+=1),pointsx=[],pointsy=[];for(var e=0;e<8;e+=1)terrain.checkCollision(fl.x+fl.r*Math.cos(angles[e]),fl.y+fl.r*Math.sin(angles[e]),[TERTYPE.WALL,TERTYPE.WALL_LIGHT,TERTYPE.WATER,TERTYPE.WATER_LIGHT])&&(pointsx.push(e<4?e/2-1:(8-e)/2-1),e<2?pointsy.push(-e/2):e<4?pointsy.push(-(4-e)/2):e<6?pointsy.push(e/2-2):pointsy.push((8-e)/2));if(0==pointsx.length)stuckCounter=0,move(moveVector);else if(pointsx.length>=6){stuckCounter+=1;var t=terrain.pw/2-fl.x,r=terrain.ph/2-fl.y,s=Math.abs(t+r);move(moveVector=[stuckCounter*t/s,stuckCounter*r/s])}else if(stuckCounter+=1,midx=Math.floor(pointsx.length/2),median=pointsx.length%2!=0?pointsx[midx]:(pointsx[midx-1]+pointsx[midx])/2,moveVector[0]=stuckCounter*median/50,median=pointsy.length%2!=0?pointsy[midx]:(pointsy[midx-1]+pointsy[midx])/2,moveVector[1]=stuckCounter*median/50,stuckCounter>=10&&(moveVector[0]+=stuckCounter*(Math.random()-.5)/10,moveVector[1]+=stuckCounter*(Math.random()-.5)/10),0==moveVector[0]&&0==moveVector[1]||moveVector.includes(NaN)){var t=terrain.w*terrain.res/2-fl.x,r=terrain.h*terrain.res/2-fl.y,s=Math.abs(t+r);move(moveVector=[stuckCounter*t/s,stuckCounter*r/s])}else move(moveVector);if(ctx.clearRect(0,0,w,h),ctx.drawImage(terrain.c,terrain.dx,terrain.dy,w,h,0,0,w,h),fl.render(ctx),iter+=1,0==(iter%=10)){var a=new Date;fps=(fps+1e3/(a-prev))/2,prev=a}else prev=new Date;ctx.fillStyle="black",ctx.fillText("FPS: "+fps,20,20),window.requestAnimationFrame(draw)};window.requestAnimationFrame(draw);
